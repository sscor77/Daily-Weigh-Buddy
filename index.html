<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeighBuddy</title>

  <!-- Manifest y colores -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3a0ca3">
  
  <!-- Metaetiquetas para iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="WeighBuddy">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Estilos externos -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-weight-scale"></i> WeighBuddy</h1>
    <p>Tu compa침ero para seguir tu progreso</p>
  </header>

  <main>
    <section class="card">
      <h2>Datos personales</h2>
      <label for="startWeight">Peso inicial (kg):</label>
      <input type="number" id="startWeight">

      <label for="height">Altura (cm):</label>
      <input type="number" id="height">

      <label for="goal">Meta de peso (kg):</label>
      <input type="number" id="goal">

      <button onclick="saveProfile()"><i class="fa-solid fa-user-check"></i> Guardar perfil</button>
    </section>

    <section class="card">
      <h2>Seguimiento</h2>
      <label for="weight">Nuevo peso (kg):</label>
      <input type="number" id="weight">
      <button onclick="addWeight()"><i class="fa-solid fa-plus"></i> A침adir peso</button>

      <div id="results"></div>
      <canvas id="weightChart"></canvas>
    </section>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- L칩gica -->
  <script>
    let profile = JSON.parse(localStorage.getItem("profile")) || { startWeight: null, height: null, goal: null };
    let weights = JSON.parse(localStorage.getItem("weights")) || [];

    const ctx = document.getElementById("weightChart").getContext("2d");
    let chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: weights.map((_, i) => `D칤a ${i+1}`),
        datasets: [{
          label: "Peso (kg)",
          data: weights,
          borderColor: "#3a0ca3",
          backgroundColor: "rgba(58,12,163,0.2)",
          fill: true,
          tension: 0.3,
          pointRadius: 5,
          pointBackgroundColor: "#7209b7"
        }]
      },
      options: {
        plugins: {
          legend: { display: false }
        }
      }
    });

    function saveProfile() {
      const startWeight = parseFloat(document.getElementById("startWeight").value);
      const height = parseFloat(document.getElementById("height").value);
      const goal = parseFloat(document.getElementById("goal").value);
      
      if (isNaN(startWeight) || isNaN(height) || isNaN(goal)) {
        showNotification('Por favor, completa todos los campos con valores v치lidos', 'error');
        return;
      }
      
      if (goal <= 0 || startWeight <= 0 || height <= 0) {
        showNotification('Los valores deben ser mayores a cero', 'error');
        return;
      }
      
      profile.startWeight = startWeight;
      profile.height = height;
      profile.goal = goal;
      localStorage.setItem("profile", JSON.stringify(profile));
      
      showNotification('Perfil guardado correctamente', 'success');
      updateResults();
    }

    function addWeight() {
      const weightInput = document.getElementById("weight");
      const weight = parseFloat(weightInput.value);
      
      if (isNaN(weight)) {
        showNotification('Por favor, introduce un peso v치lido', 'error');
        return;
      }
      
      if (weight <= 0) {
        showNotification('El peso debe ser mayor a cero', 'error');
        return;
      }
      
      weights.push(weight);
      localStorage.setItem("weights", JSON.stringify(weights));
      updateChart();
      weightInput.value = "";
      
      showNotification('Peso a침adido correctamente', 'success');
    }

    function updateChart() {
      chart.data.labels = weights.map((_, i) => `D칤a ${i+1}`);
      chart.data.datasets[0].data = weights;
      chart.update();
      updateResults();
    }

    function updateResults() {
      if (profile.startWeight && profile.goal) {
        const last = weights[weights.length - 1] || profile.startWeight;
        const diff = last - profile.goal;
        const resultText = diff > 0 
          ? `Te faltan ${diff.toFixed(1)} kg para tu meta.`
          : `춰Has alcanzado tu meta! 游꿀`;
        document.getElementById("results").innerText = 
          `칔ltimo peso: ${last} kg\n${resultText}`;
      }
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 30px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        background: ${type === 'success' ? '#4caf50' : '#f44336'};
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 3000);
    }

    // Instalaci칩n de la PWA
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallPromotion();
    });

    function showInstallPromotion() {
      const installButton = document.createElement('button');
      installButton.textContent = 'Instalar WeighBuddy';
      installButton.id = 'installButton';
      installButton.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #3a0ca3, #7209b7);
        color: white;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;
        font-weight: bold;
      `;
      
      installButton.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
          console.log('Usuario acept칩 la instalaci칩n');
        }
        
        deferredPrompt = null;
        document.body.removeChild(installButton);
      });
      
      document.body.appendChild(installButton);
    }

    // Cargar datos guardados
    if (profile.startWeight) document.getElementById("startWeight").value = profile.startWeight;
    if (profile.height) document.getElementById("height").value = profile.height;
    if (profile.goal) document.getElementById("goal").value = profile.goal;
    updateChart();

    // Solicitar permiso para notificaciones (opcional)
    function askNotificationPermission() {
      if (!('Notification' in window)) {
        console.log('Notificaciones no soportadas');
        return;
      }
      
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          console.log('Permiso para notificaciones concedido');
        }
      });
    }

    // Llamar a la funci칩n de permiso de notificaciones cuando el usuario interact칰e
    // Por ejemplo, al hacer clic en un bot칩n o al guardar el perfil
    // askNotificationPermission();
  </script>

  <!-- Registrar Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js")
        .then(() => console.log("Service Worker registrado"))
        .catch(err => console.error("Error al registrar SW:", err));
    }
  </script>
</body>
</html>
